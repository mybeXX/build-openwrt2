name: build x86/64 openwrt

on:
  workflow_dispatch:
    inputs:
      source:
        description: 'é€‰æ‹©è¦ç¼–è¯‘çš„æºç '
        required: true
        default: 'immwrt'
        type: choice
        options: ['immwrt', 'lean']

      version:
        description: 'è¾“å…¥ç‰ˆæœ¬å· (ä¾‹å¦‚: 24.10.4, v23.05.7, æˆ– master)'
        required: true
        default: '24.10.4'
        type: string

      target:
        description: 'é€‰æ‹©æœºå‹'
        required: true
        default: 'x86-64'
        type: choice
        options: ['x86-64']

      ip_address:
        description: 'è®¾ç½®é»˜è®¤IPåœ°å€'
        required: false
        default: '10.0.0.1'

      partsize:
        description: 'è®¾ç½®rootfså¤§å° (MB)'
        required: false
        default: '500'

      release:
        description: 'ä¸Šä¼ åˆ° Releases'
        required: false
        default: true
        type: boolean

jobs:
  build:
    name: build ${{inputs.target}} ${{inputs.source}}
    runs-on: ubuntu-24.04

    env:
      IP_ADDRESS: ${{inputs.ip_address}}
      PART_SIZE: ${{inputs.partsize}}
      DIY_SCRIPT: ${{inputs.source}}.sh
      REPO_BRANCH: ${{inputs.version}}
      TZ: Asia/Shanghai

    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Initialization Environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt -yqq update
          sudo -E apt -yqq install $(curl -fsSL is.gd/depends_ubuntu_2404)
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown runner:runner /workdir

      - name: Clone Source Code
        run: |
          if [ "${{ inputs.source }}" == "immwrt" ]; then
            REPO_URL="https://github.com/immortalwrt/immortalwrt"
          else
            REPO_URL="https://github.com/coolsnowwolf/lede"
          fi
          
          # å…ˆæµ…å…‹éš† masterï¼Œç„¶åè·å–æ ‡ç­¾å¹¶åˆ‡æ¢ï¼Œè§£å†³ 128 é”™è¯¯
          git clone --depth 1 $REPO_URL /workdir/openwrt
          cd /workdir/openwrt
          git fetch --tags
          # å°è¯•ç›´æ¥åˆ‡æ¢æˆ–åŠ  v å‰ç¼€åˆ‡æ¢
          git checkout $REPO_BRANCH || git checkout v$REPO_BRANCH || echo "Using default branch"
          
          echo "OPENWRT_PATH=/workdir/openwrt" >> $GITHUB_ENV
          echo "REPO_URL=$REPO_URL" >> $GITHUB_ENV

      - name: Get Commit Data
        run: |
          cd $OPENWRT_PATH
          echo "COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')" >> $GITHUB_ENV
          echo "COMMIT_DATE=$(git log -1 --pretty=format:'%ad')" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')" >> $GITHUB_ENV
          echo "COMMIT_HASH=$(git log -1 --pretty=format:'%h')" >> $GITHUB_ENV
          echo "KERNEL_VERSION=$(grep -oP '(?<=KERNEL_PATCHVER:=).*' target/linux/x86/Makefile || echo "Unknown")" >> $GITHUB_ENV

      - name: Load Custom Configuration
        run: |
          # è¿™é‡Œçš„æ“ä½œä¼šè§¦å‘ä¸‹æ–¹çš„ immwrt.sh è„šæœ¬
          [ -e "configs/${{inputs.target}}-${{inputs.source}}.config" ] && cp "configs/${{inputs.target}}-${{inputs.source}}.config" $OPENWRT_PATH/.config
          chmod +x $DIY_SCRIPT
          cd $OPENWRT_PATH
          $GITHUB_WORKSPACE/$DIY_SCRIPT

      - name: Compile Firmware
        id: compile
        run: |
          cd $OPENWRT_PATH
          make defconfig
          make -j$(nproc) || make -j1 V=s
          echo "DATE=$(date +"%Y.%m.%d-%H:%M")" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Upload Firmware To Release
        if: steps.compile.outputs.status == 'success' && inputs.release == 'true'
        uses: ncipollo/release-action@main
        with:
          name: ${{ inputs.target }}-${{ inputs.version }}-${{ env.DATE }}
          tag: ${{ inputs.target }}-${{ inputs.version }}-${{ env.DATE }}
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: ${{ env.OPENWRT_PATH }}/bin/targets/${{ inputs.target }}/*/*
          body: |
            **è¿™æ˜¯åŸºäº ${{ inputs.version }} ç‰ˆæœ¬ç¼–è¯‘çš„å›ºä»¶**
            ### ğŸ“’ å›ºä»¶ä¿¡æ¯
            - ğŸ’» å¹³å°æ¶æ„: ${{ inputs.target }}
            - âš½ å›ºä»¶æºç : ${{ env.REPO_URL }}
            - ğŸ’ æºç åˆ†æ”¯: ${{ inputs.version }}
            - ğŸš€ å†…æ ¸ç‰ˆæœ¬: ${{ env.KERNEL_VERSION }}
            - ğŸŒ é»˜è®¤åœ°å€: ${{ env.IP_ADDRESS }}
            - ğŸ”‘ é»˜è®¤å¯†ç : password
            ### ğŸ§Š æºç æœ€æ–°è®°å½•
            - **ä½œè€…**: ${{ env.COMMIT_AUTHOR }}
            - **æ—¥æœŸ**: ${{ env.COMMIT_DATE }}
            - **æ‘˜è¦**: ${{ env.COMMIT_MESSAGE }}
            - **å“ˆå¸Œ**: ${{ env.COMMIT_HASH }}
